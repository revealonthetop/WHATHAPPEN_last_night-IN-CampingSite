<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>돌 피하기 게임</title>

    <style>
        canvas {
            background-color: #112330;
        }

        body {
            background-color: black;
        }

        div {
            display: flex;
            justify-content: center;
        }

        #scoreBoard {
            display: flex;
            width: 200px;
            height: 600px;
            background-color: grey;
            margin:30px;
        }
    </style>

</head>

<body>
    <div>
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="scoreBoard">
            <h1>점수판</h1>
        </div>
    </div>
    <script>
        //캔버스 객체
        let canvas;
        let ctx;
        let canvasBuffer;
        let bufferCtx;
        let threadSpeed = 16;

        //우주선
        let spaceship;
        let sx, sy, sw = 60, sh = 35;

        //배경이미지
        let background;

        //장애물
        let enemy = new Array();
        let enemyColor = ['gray', 'blue', 'silver'];
        let ellapse = 10;
        let enemySize = [3, 5,15]

        //타이머
        let loopInstance;

        //게임의 상태
        let STATE_START = false;
        let STATE_GAMEOVER = false;

        //키 상태 (게임시작 : enter, 게임다시시작 : space, 방향키 (4개))
        let keyPressed = [];

        //경과 시간
        let oldTime;
        let startTime;
        let totalTime;

        //이벤트 등록
        window.addEventListener('load', initialize, false);
        window.addEventListener('keydown', getKeyDown, false);
        window.addEventListener('keyup', getKeyUp, false);

        function initialize() {
            canvas = document.getElementById('canvas');
            if (canvas == null || canvas.getContext == null)
                return;
            ctx = canvas.getContext('2d');

            canvasBuffer = document.createElement('canvas');
            canvasBuffer.width = canvas.width;
            canvasBuffer.height = canvas.height;
            bufferCtx = canvasBuffer.getContext('2d');

            //게임 시작 메시지
            startMessage();

            //이미지 설정
            setImage();

            //반복 동작 설정
            loopInstance = setInterval(update, threadSpeed);
        }

        function startGame() {
            STATE_START = true;
            //캐릭터 초기 위치
            sx = canvas.width / 2;
            sy = canvas.height / 2;
            sw = 60;
            sh = 35;

            //장애물 생성
            createObstacle();

            //현재 시간 저장

            startTime = getTime();
        }

        function getTime() {
            let date = new Date();
            let time = date.getTime();
            delete date;
            return time;
        }

        function update() {
            if ((keyPressed[13] == true) && (STATE_START == false)) { //엔터키 눌렀을 때
                //게임 시작
                console.log('게임 시작');

                startGame();
            }

            if (keyPressed[38]) {
                sy = sy - 2;
            }
            if (keyPressed[40]) {
                sy = sy + 2;
            }
            if (keyPressed[37]) {
                sx = sx - 2;
            }
            if (keyPressed[39]) {
                sx = sx + 2;
            }

            if (keyPressed[32] == true) {
                document.location.reload();
                startGame();
            }

            if (STATE_START) {
                //장애물 이동
                moveObstacle(ellapse);

                //그림 그리기
                drawAll();
            }

        }

        function moveObstacle(ellapse) {
            for (let i = 0; i < 60; i++) {
                let mx = enemy[i].vx * ellapse / 1000;
                let my = enemy[i].vy * ellapse / 1000;

                enemy[i].x = enemy[i].x + mx;
                enemy[i].y = enemy[i].y + my;

                if (enemy[i].x > canvas.width)
                    enemy[i].x = 0;
                if (enemy[i].x < 0)
                    enemy[i].x = canvas.width;
                if (enemy[i].y > canvas.height)
                    enemy[i].y = 0;
                if (enemy[i].y < 0)
                    enemy[i].y = canvas.height;

                //충돌 검사
                crashObstacle(i);
            }
        }
        // 충돌 검사
        function crashObstacle(index) {
            let mx = enemy[index].x;
            let my = enemy[index].y;
            // 이미지의 절반만큼 범위를 주고 충돌 검사.
            if (mx > sx - sw / 2 && mx < sx + sw / 2 && my > sy - sh / 2 && my < sy + sh / 2) {
                STATE_GAMEOVER = true;
            }
        }

        function createObstacle() {
            enemy.length = 0;
            for (let i = 0; i < 60; i++) {
                enemy.push(
                    {
                        x: Math.random() * canvas.width,
                        y: (i < 30) ? 20 : canvas.height - 20,
                        vx: Math.random() * 200 - 100,
                        vy: Math.random() * 200 - 100,
                        color: Math.floor(Math.random() * 3)
                    }
                );
            }
        }


        function drawAll() {
            if (!STATE_START) {
                return;
            } else if (STATE_GAMEOVER) {
                //개임 오버 메시지
                STATE_START = false;
                drawText("bold 30px arial", "#ffff00", "center", "Game Over", 60);
                drawText("bold 20px arial", "#ffffff", "center", "Spacebar to Restart", 20);
            } else {
                //게임 시작 시 엔터키를 눌렀을 때
                bufferCtx.drawImage(background, 0, 0);
                bufferCtx.drawImage(spaceship, sx - sw / 2, sy - sh / 2);
                ctx.drawImage(canvasBuffer, 0, 0);

                //장애물 출력
                drawObstacle();

                totalTime = getTime() - startTime;
                ctx.font = "bold 20px arial";
                ctx.fillStyle = "#ffff00";
                ctx.textAlign = "center";
                ctx.fillText(totalTime, canvas.width - 30, 30);
            }
        }

        //장애물 출력
        function drawObstacle() {
            for (let i = 0; i < 60; i++) {
                ctx.beginPath();
                ctx.arc(enemy[i].x, enemy[i].y, enemySize[fizzbuzz(i)], 0, 2 * Math.PI);
                ctx.fillStyle = enemyColor[enemy[i].color];
                ctx.closePath();
                ctx.fill();
            }
        }

        function getKeyDown(event) {
            console.log(event);
            keyPressed[event.keyCode] = true;
        }

        function getKeyUp(event) {
            keyPressed[event.keyCode] = false;
        }
        // 이미지 세팅
        function setImage() {
            spaceship = new Image();
            spaceship.src = "spaceship.png";
            background = new Image();
            background.src = "space.jpg";
        }

        function drawText(font, color, align, text, ygap) {
            ctx.font = font;
            ctx.fillStyle = color;
            ctx.textAlign = align;
            ctx.fillText(text, canvas.width / 2, canvas.height / 2 - ygap);
        }

        function startMessage() {
            drawText("bold 30px arial", "#ffff00", "center", "Enter To Start", 60);
            drawText("bold 20px arial", "#ffffff", "center", "조작 방향키 ←↑→↓", 20);
        }

        function saveScore() {

        }

        function fizzbuzz(num) {
            let i = 1
            if ((num % 3 == 0) && (num % 5 == 0)) {
                return 2
            }
            if (num % 3 == 0) {
                return 0
            }
            if (num % 5 == 0) {
                return 1
            }
            return 1

        }

    </script>

</body>

</html>